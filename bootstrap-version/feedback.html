<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UX Study Portal  Assignment Results</title>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- Non-blocking fonts -->
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Inter:wght@400;500;600;700&display=swap">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
  <!-- Non-blocking FontAwesome -->
  <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"></noscript>
  <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"></noscript>
  <link href="../shared/css/tokens.css" rel="stylesheet">
  <link href="../shared/css/bridge-bootstrap.css" rel="stylesheet">
  <link href="../shared/css/app.css" rel="stylesheet">
  <style>
    :root { --edu-navy:#1a2f5a; --edu-blue:#2558a8; --edu-light:#eef3fb; --edu-border:#d0d9e8; }
    body { font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif !important; background:#f0f4fb; overflow-x:auto; font-weight:500; -webkit-font-smoothing:antialiased; }
    .portal-topbar { position:fixed;top:0;left:0;right:0;z-index:100;height:56px;background:var(--edu-navy);display:flex;align-items:center;justify-content:space-between;padding:0 20px;box-shadow:0 2px 10px rgba(0,0,0,.3); }
    .topbar-brand { display:flex;align-items:center;gap:9px;color:#fff;font-size:.88rem;font-weight:600;text-decoration:none; }
    .topbar-brand i { color:#90b8e8;font-size:1.05rem; }
    .topbar-brand .edition { font-size:.73rem;font-weight:400;opacity:.6;background:rgba(255,255,255,.12);padding:2px 7px;border-radius:4px; }
    .page-stack { min-width:320px;max-width:960px;margin:0 auto;padding:58px 16px 20px; }
    @media(min-width:1024px){ .page-stack{max-width:1100px;padding:58px 24px 20px;} }
    @media(min-width:1280px){ .page-stack{max-width:1250px;padding:58px 32px 20px;} }
    @media(min-width:1600px){ .page-stack{max-width:1450px;padding:58px 40px 20px;} }
    .step-track { display:flex;align-items:center;padding:14px 18px;background:#fff;border:1px solid var(--edu-border);border-radius:10px;margin-bottom:20px;box-shadow:0 1px 4px rgba(26,47,90,.06); }
    .step-node { display:flex;flex-direction:column;align-items:center;gap:5px;flex:1; }
    .step-node__circle { width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.82rem; }
    .step-node__circle.is-done { background:#16a34a;color:#fff; }
    .step-node__circle.is-active { background:var(--edu-blue);color:#fff;box-shadow:0 0 0 3px rgba(37,88,168,.18); }
    .step-node__text { font-size:.76rem;font-weight:500;color:#5c7099;text-align:center; }
    .step-node__text.is-active { color:var(--edu-blue);font-weight:600; }
    .step-node__text.is-done { color:#16a34a; }
    .step-line { height:2px;flex:1;max-width:36px;background:#ccd9f0;margin-bottom:18px; }
    .step-line.done { background:#16a34a; }
    .panel-card { background:#fff;border:1px solid var(--edu-border);border-radius:12px;box-shadow:0 4px 28px rgba(26,47,90,.09);overflow:hidden;margin-bottom:14px; }
    .panel-card__head { background:var(--edu-navy);padding:22px 28px 18px;display:flex;gap:16px;align-items:flex-start; }
    .head-icon { width:48px;height:48px;flex-shrink:0;background:rgba(255,255,255,.12);border-radius:9px;display:flex;align-items:center;justify-content:center; }
    .head-icon i { font-size:1.7rem;color:#90b8e8; }
    .head-text h1 { font-family:'Poppins',sans-serif !important;font-size:1.5rem;font-weight:700;color:#fff;margin:0 0 4px !important;letter-spacing:-0.02em; }
    .head-text p { font-size:.92rem;color:#8ab0d8;margin:0 !important;line-height:1.5;font-weight:500; }
    .panel-card__body { padding:24px 28px; }
    .stat-grid { display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px; }
    .stat-card { border:1px solid var(--edu-border);border-radius:10px;padding:14px 16px;background:var(--edu-light);display:flex;flex-direction:column;gap:4px; }
    .stat-card__icon { font-size:1.3rem;color:#6090c8; }
    .stat-card__value { font-size:1.75rem;font-weight:800;color:var(--edu-navy);line-height:1; }
    .stat-card__label { font-size:.9rem;color:#64748b;font-weight:600; }
    .table-wrap { overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:20px; }
    .fb-table { width:100%;border-collapse:collapse;min-width:580px; }
    .fb-table th { padding:12px 14px;text-align:left;font-size:.92rem;font-weight:700;color:#64748b;border-bottom:2px solid var(--edu-border);background:var(--edu-light);text-transform:uppercase;letter-spacing:.4px; }
    .fb-table td { padding:16px 14px;vertical-align:top;border-bottom:1px solid #eef2f8;font-size:1rem;font-weight:500; }
    .fb-table tr:last-child td { border-bottom:none; }
    .fb-table tr:hover td { background:#f0f5ff; }
    :root[data-theme="dark"] .fb-table tr:hover td { background:#1e2d48 !important; }
    .score-bar-wrap { margin-top:5px; }
    .score-bar-track { height:6px;background:#e2e8f0;border-radius:99px;overflow:hidden; }
    .score-bar-fill { height:100%;border-radius:99px;transition:width .4s; }
    .score-meta { font-size:.88rem;color:#64748b;margin-top:4px;font-weight:500; }
    .score-delta { font-weight:600; }
    .score-delta.pass { color:#16a34a; }
    .score-delta.fail { color:#dc2626; }
    .status-badge { display:inline-flex;align-items:center;gap:5px;padding:4px 11px;border-radius:99px;font-size:.9rem;font-weight:700; }
    .status-badge.pass { background:#dcfce7;color:#166534; }
    .status-badge.fail { background:#fee2e2;color:#991b1b; }
    .accordion-toggle { background:none;border:none;padding:0;font-size:.95rem;color:var(--edu-blue);font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px; }
    .accordion-toggle i { transition:transform .2s;font-size:.7rem; }
    .accordion-toggle.open i { transform:rotate(180deg); }
    .accordion-body { display:none;margin-top:8px;font-size:.95rem;color:#475569;line-height:1.7;padding:12px 14px;background:var(--edu-light);border-radius:8px;border-left:3px solid var(--edu-blue);font-weight:500; }
    .accordion-body.visible { display:block; }
    .doc-panel { display:none;padding:16px 18px;margin-bottom:20px;background:#fff8f0;border:1px solid #f0d8a8;border-radius:10px; }
    .doc-panel.visible { display:block; }
    .doc-panel__header { display:flex;justify-content:space-between;align-items:center;margin-bottom:12px; }
    .doc-panel__title { font-size:.85rem;font-weight:600;color:#7a4a10;display:flex;align-items:center;gap:6px; }
    .doc-panel__close { background:none;border:none;font-size:1rem;color:#a07040;cursor:pointer; }
    .doc-panel__row { display:flex;gap:8px;margin-bottom:6px;font-size:.86rem; }
    .doc-panel__label { color:#a07040;font-weight:600;min-width:100px;flex-shrink:0; }
    .doc-panel__value { color:#344;line-height:1.5; }
    .quest-banner { background:var(--edu-navy);border-radius:14px;padding:28px 32px;display:flex;align-items:center;gap:20px;box-shadow:0 6px 24px rgba(26,47,90,.25); }
    .quest-banner__icon { width:64px;height:64px;flex-shrink:0;background:rgba(255,255,255,.12);border-radius:12px;display:flex;align-items:center;justify-content:center; }
    .quest-banner__icon i { font-size:1.8rem;color:#90b8e8; }
    .quest-banner__body { flex:1; }
    .quest-banner__body h3 { font-size:1.1rem;font-weight:700;color:#fff;margin:0 0 6px !important; }
    .quest-banner__body p { font-size:.95rem;color:#8ab0d8;margin:0 !important;line-height:1.5; }
    .btn-quest { flex-shrink:0;background:#fff;color:var(--edu-navy);border:none;border-radius:10px;padding:.75rem 1.8rem;font-weight:700;font-size:1rem;display:inline-flex;align-items:center;gap:8px;text-decoration:none;transition:all .2s;white-space:nowrap;letter-spacing:0.01em;box-shadow:0 2px 8px rgba(0,0,0,.15); }
    .btn-quest:hover { opacity:.9;color:var(--edu-navy);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.2); }
    .empty-state { text-align:center;padding:48px 20px;color:#64748b; }
    .empty-state i { font-size:3rem;color:#c8d8ee;margin-bottom:12px; }
    .empty-state h3 { font-size:1rem;font-weight:600;color:#344566;margin-bottom:6px !important; }
    .btn-sm-edu { font-size:.87rem;padding:.36rem .8rem;border-radius:6px;display:inline-flex;align-items:center;gap:5px;transition:.15s;cursor:pointer;font-weight:700;border:none;letter-spacing:0.01em; }
    .btn-sm-view { background:var(--edu-light);border:1px solid #b8cee8;color:var(--edu-blue); }
    .btn-sm-view:hover { background:var(--edu-blue);color:#fff; }
    .theme-switch { position:fixed;left:20px;bottom:20px;z-index:100;padding:12px 20px;border-radius:999px;border:2px solid var(--edu-border);background:#fff;color:#475569;font-size:.95rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(26,47,90,.15);transition:all .2s ease; }
    .theme-switch:hover { transform:translateY(-2px);box-shadow:0 6px 20px rgba(26,47,90,.25);border-color:#2558a8; }
    .theme-switch i { font-size:1.1rem; }
    :root[data-theme="dark"] body { background:#0d1320; }
    :root[data-theme="dark"] .step-track,:root[data-theme="dark"] .panel-card { background:#182030;border-color:#2d3d5a;color:#e0e8f0; }
    :root[data-theme="dark"] .step-node__text { color:#90b8e8; }
    :root[data-theme="dark"] .step-node__text.is-active,:root[data-theme="dark"] .step-node__text.is-done { color:#6db3f2; }
    :root[data-theme="dark"] .stat-card { background:#1a2540;border-color:#2d3d5a; }
    :root[data-theme="dark"] .stat-card__value { color:#a8d0f8; }
    :root[data-theme="dark"] .stat-card__label { color:#b0c8e8; }
    :root[data-theme="dark"] .fb-table th { background:#1a2540;border-bottom-color:#2d3d5a;color:#d0e0f8 !important; }
    :root[data-theme="dark"] .fb-table td { background:#182030;border-bottom-color:#2d3d5a;color:#e8f0f8 !important; }
    :root[data-theme="dark"] .fb-table td strong { color:#f0f4fc !important; }
    :root[data-theme="dark"] .score-meta { color:#a0b8d8; }
    :root[data-theme="dark"] .accordion-toggle { color:#6db3f2; }
    :root[data-theme="dark"] .accordion-body { background:#182540;color:#b8d8f0; }
    :root[data-theme="dark"] .doc-panel { background:#1e1808;border-color:#3a2e10; }
    :root[data-theme="dark"] .doc-panel__title { color:#c8a860; }
    :root[data-theme="dark"] .doc-panel__label { color:#b89850; }
    :root[data-theme="dark"] .doc-panel__value { color:#e0d0a8; }
    :root[data-theme="dark"] .empty-state { color:#a0b8d8; }
    :root[data-theme="dark"] .empty-state h3 { color:#d0e0f0; }
    :root[data-theme="dark"] .quest-banner__body p { color:#b0c8e8; }
    :root[data-theme="dark"] .theme-switch { background:#182030;border-color:#3d5d8a;color:#90b0d8;box-shadow:0 4px 16px rgba(0,0,0,.3); }
    :root[data-theme="dark"] .theme-switch:hover { border-color:#4a7bc8;box-shadow:0 6px 20px rgba(0,0,0,.4); }
    :root[data-theme="dark"] .btn-outline-light { background:#2d3d5a !important;border-color:#3d5d8a !important;color:#c8d8f0 !important; }
    :root[data-theme="dark"] .btn-outline-light:hover { background:#3d4d6a !important;border-color:#4a7bc8 !important;color:#e0e8f0 !important; }
    @media(max-width:540px){ .page-stack{padding:58px 12px 16px;max-width:100%;} .stat-grid{grid-template-columns:repeat(2,1fr);} .quest-banner{flex-direction:column;text-align:center;} .panel-card__head{padding:18px;} .panel-card__body{padding:16px 18px;} .topbar-brand .edition{display:none;} }
    /* CLS: reserve icon space before FontAwesome loads */
    .step-node__circle i,.stat-card__icon i,.head-icon i,.quest-banner__icon i,.topbar-brand i { display:inline-block;min-width:.8em;min-height:.8em; }
    /* CLS: reserve space for stat values filled by JS */
    .stat-card__value { min-height:2rem;display:block;min-width:3rem;text-align:left; }
    /* Skeleton pulse animation */
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
    :root[data-theme="dark"] #history [style*="background:#e0e8f0"] { background:#2d3d5a !important; }
    /* Hide #fb since inline renderEnhancedFeedback handles display */
    #fb { display:none; }
    /* CLS: reserve height for #history skeleton area */
    #history { min-height:200px; }
    /* font-display: swap for FontAwesome icon fonts */
    @font-face { font-family:'Font Awesome 6 Free'; font-display:swap; }
    @font-face { font-family:'Font Awesome 6 Brands'; font-display:swap; }
    @font-face { font-family:'Font Awesome 6 Pro'; font-display:swap; }
  </style>
</head>
<body data-framework="bootstrap" data-page="feedback">
  <a class="skip-link visually-hidden-focusable" href="#main">Skip to main content</a>
  <div id="statusLive" class="visually-hidden" aria-live="polite"></div>
  <header class="portal-topbar" role="banner">
    <a class="topbar-brand" href="./index.html">
      <i class="fa-solid fa-building-columns" aria-hidden="true"></i>
      <span>UX Study Portal</span>
      <span class="edition">Bootstrap Edition</span>
    </a>
    <div style="display:flex;align-items:center;gap:8px;">
      <span id="pidBadge" style="font-size:.76rem;color:#90b8e8;font-weight:500;">ID: </span>
      <button id="logoutBtn" type="button" class="btn btn-sm btn-outline-light" title="Reset Study ID" style="font-size:.76rem;">
        <i class="fa-solid fa-rotate-left"></i>
      </button>
      <button id="copyIdBtn" class="btn btn-sm btn-outline-light" type="button" title="Copy Study ID" style="font-size:.76rem;">
        <i class="fa-regular fa-copy"></i>
      </button>
    </div>
  </header>

  <main id="main" class="page-stack" role="main" tabindex="-1">
    <nav class="step-track" aria-label="Study session steps">
      <div class="step-node">
        <div class="step-node__circle is-done"><i class="fa-solid fa-check" aria-hidden="true"></i></div>
        <span class="step-node__text is-done">Sign In</span>
      </div>
      <div class="step-line done" aria-hidden="true"></div>
      <div class="step-node">
        <div class="step-node__circle is-done"><i class="fa-solid fa-check" aria-hidden="true"></i></div>
        <span class="step-node__text is-done">Submit</span>
      </div>
      <div class="step-line done" aria-hidden="true"></div>
      <div class="step-node">
        <div class="step-node__circle is-active" aria-current="step">
          <i class="fa-solid fa-award" aria-hidden="true"></i>
        </div>
        <span class="step-node__text is-active">Results</span>
      </div>
    </nav>
    <div class="panel-card">
      <div class="panel-card__head">
        <div class="head-icon"><i class="fa-solid fa-scroll" aria-hidden="true"></i></div>
        <div class="head-text">
          <h1>Assignment Feedback &amp; Results</h1>
          <p>Review your submissions, compare scores against pass marks, and read your tutor's comments.</p>
        </div>
      </div>
      <div class="panel-card__body">
        <div class="stat-grid" id="statGrid" aria-label="Summary statistics">
          <div class="stat-card">
            <span class="stat-card__icon"><i class="fa-solid fa-inbox" aria-hidden="true"></i></span>
            <span class="stat-card__value" id="statCount">—</span>
            <span class="stat-card__label">Submissions</span>
          </div>
          <div class="stat-card">
            <span class="stat-card__icon"><i class="fa-solid fa-star-half-stroke" aria-hidden="true"></i></span>
            <span class="stat-card__value" id="statAvg">—</span>
            <span class="stat-card__label">Average Score</span>
          </div>
          <div class="stat-card">
            <span class="stat-card__icon"><i class="fa-solid fa-circle-check" aria-hidden="true"></i></span>
            <span class="stat-card__value" id="statPassed">—</span>
            <span class="stat-card__label">Passed</span>
          </div>
        </div>

        <div class="doc-panel" id="docPanel" role="region" aria-label="Submission details">
          <div class="doc-panel__header">
            <span class="doc-panel__title">
              <i class="fa-solid fa-file-lines" aria-hidden="true"></i> Submission Details
            </span>
            <button class="doc-panel__close" onclick="document.getElementById('docPanel').classList.remove('visible')" aria-label="Close details panel">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div id="docPanelContent"></div>
        </div>
        <div id="fb" aria-live="polite"></div>
        <div id="history">
          <!-- Loading skeleton - replaced by JS -->
          <div class="table-wrap"><table class="fb-table" aria-label="Loading submissions"><thead><tr><th><i class="fa-solid fa-file-lines me-1"></i>Assignment</th><th><i class="fa-solid fa-star-half-stroke me-1"></i>Score vs Pass Mark</th><th><i class="fa-solid fa-circle-half-stroke me-1"></i>Status</th><th><i class="fa-solid fa-chalkboard me-1"></i>Tutor Feedback</th></tr></thead><tbody><tr><td><div style="background:#e0e8f0;height:80px;border-radius:6px;animation:pulse 1.5s ease-in-out infinite;"></div></td><td><div style="background:#e0e8f0;height:60px;border-radius:6px;animation:pulse 1.5s ease-in-out infinite;animation-delay:0.1s;"></div></td><td><div style="background:#e0e8f0;height:30px;width:80px;border-radius:6px;animation:pulse 1.5s ease-in-out infinite;animation-delay:0.2s;"></div></td><td><div style="background:#e0e8f0;height:40px;border-radius:6px;animation:pulse 1.5s ease-in-out infinite;animation-delay:0.3s;"></div></td></tr></tbody></table></div>
        </div>
      </div>
    </div>

    <div class="quest-banner" role="complementary" aria-label="Study questionnaire">
      <div class="quest-banner__icon"><i class="fa-solid fa-clipboard-list" aria-hidden="true"></i></div>
      <div class="quest-banner__body">
        <h3>Complete the Study Questionnaire</h3>
        <p>After reviewing your feedback, please fill in the SUS + UEQ usability questionnaire. Your Study ID will be pre-filled.</p>
      </div>
      <a id="questLink" href="https://docs.google.com/forms/d/e/1FAIpQLSfKiFssElyNNoaZ-PcQe2AoE-jSLSGaaoL-YyqCAY69zTVpBA/viewform?usp=header" target="_blank" rel="noopener" class="btn-quest">
        <i class="fa-solid fa-arrow-up-right-from-square" aria-hidden="true"></i>
        Open Questionnaire
      </a>
    </div>
  </main>

  <button id="themeToggle" class="theme-switch" type="button" aria-label="Toggle colour theme" aria-pressed="false" onclick="toggleTheme()">
    <i class="fa-regular fa-moon" aria-hidden="true"></i> Theme
  </button>
  <script type="module" src="../shared/js/app.js"></script>
  <script defer src="../shared/js/metrics.js"></script>
  <script defer src="../shared/js/theme.js"></script>
  <script>
  function scoreFor(sub){return sub.score ?? 66;}
  function passFor(sub){return sub.passMark ?? 60;}
  function feedbackFor(sub){return sub.feedback ?? 'Your work has been reviewed. Check back for detailed comments.';}
  function toggleFb(btn){const b=btn.nextElementSibling;const o=b.classList.toggle('visible');btn.classList.toggle('open',o);btn.setAttribute('aria-expanded',o);}
  function getSubs(){try{return JSON.parse(localStorage.getItem('study_submissions_v1')||'[]');}catch(e){return[];}}
  function getStudyId(){try{return JSON.parse(localStorage.getItem('study_identity_v1')||'{}').studyId||'';}catch(e){return '';}}
  function openSubmissionFile(sub){
    if(!sub.fileDataUrl){alert('No file was stored for this submission.\\n\\n(Files are saved in your browser only. If no file was chosen, or the file exceeded localStorage capacity, the content is not available.)');return;}
    try{const parts=sub.fileDataUrl.split(',');const mime=(parts[0].match(/:(.*?);/)||[])[1]||'application/octet-stream';const bstr=atob(parts[parts.length-1]);let n=bstr.length;const u8arr=new Uint8Array(n);while(n--)u8arr[n]=bstr.charCodeAt(n);const blob=new Blob([u8arr],{type:mime});const url=URL.createObjectURL(blob);window.open(url,'_blank','noopener');setTimeout(()=>URL.revokeObjectURL(url),30000);}catch(e){const a=document.createElement('a');a.href=sub.fileDataUrl;a.download=sub.fileName||'submission';a.style.display='none';document.body.appendChild(a);a.click();document.body.removeChild(a);}
  }
  function viewDoc(idx){
    const panel=document.getElementById('docPanel'),content=document.getElementById('docPanelContent');
    const mine=getSubs().filter(s=>s.studyId===getStudyId());
    const sub=mine[idx];if(!sub)return;
    const task=sub.task||sub.assignment||'(unknown)';const sc=scoreFor(sub);const pm=passFor(sub);const delta=sc-pm;const passed=delta>=0;const fb=feedbackFor(sub);
    const fileRow='<div class="doc-panel__row"><span class="doc-panel__label"><i class="fa-regular fa-file me-1"></i>File</span><span class="doc-panel__value">'+(sub.fileName||'No file attached')+(sub.fileDataUrl?'<br><button onclick="openSubmissionFile(getSubs().filter(s=>s.studyId===getStudyId())['+idx+'])" style="margin-top:8px;padding:4px 10px;background:#2558a8;color:#fff;border:none;border-radius:6px;font-size:.75rem;cursor:pointer;display:inline-flex;align-items:center;gap:5px;"><i class="fa-regular fa-file"></i> Open file</button>':'')+'</span></div>';
    content.innerHTML='<div class="doc-panel__row"><span class="doc-panel__label"><i class="fa-solid fa-book-open me-1"></i>Module</span><span class="doc-panel__value">'+task+'</span></div><div class="doc-panel__row"><span class="doc-panel__label"><i class="fa-regular fa-clock me-1"></i>Submitted</span><span class="doc-panel__value">'+(sub.createdAtISO?new Date(sub.createdAtISO).toLocaleString('en-GB'):'')+'</span></div>'+fileRow+'<div class="doc-panel__row"><span class="doc-panel__label"><i class="fa-solid fa-pen-nib me-1"></i>Notes</span><span class="doc-panel__value">'+(sub.comments||'No notes provided')+'</span></div><div class="doc-panel__row"><span class="doc-panel__label"><i class="fa-solid fa-star-half-stroke me-1"></i>Score</span><span class="doc-panel__value"><strong>'+sc+'%</strong> vs pass mark '+pm+'%  <span style="color:'+(passed?'#16a34a':'#dc2626')+';font-weight:600;">'+(passed?'+':'')+delta+'% '+(passed?'above':'below')+' pass mark</span></span></div><div class="doc-panel__row"><span class="doc-panel__label"><i class="fa-solid fa-chalkboard me-1"></i>Feedback</span><span class="doc-panel__value">'+fb+'</span></div>';
    panel.classList.add('visible');panel.scrollIntoView({behavior:'smooth',block:'start'});
  }
  function buildRow(sub,idx){
    const task=sub.task||sub.assignment||'(unknown)';const sc=scoreFor(sub);const pm=passFor(sub);const delta=sc-pm;const passed=delta>=0;const barCol=passed?'#16a34a':'#dc2626';const fb=feedbackFor(sub);const ts=sub.createdAtISO?new Date(sub.createdAtISO).toLocaleString('en-GB'):'';
    return '<tr><td><strong style="font-size:.9rem;color:#1a2f5a;">'+task+'</strong><br><span style="font-size:.82rem;color:#94a3b8;"><i class="fa-regular fa-clock"></i> '+ts+'</span>'+(sub.fileName?'<br><span style="font-size:.82rem;color:#64748b;"><i class="fa-regular fa-file"></i> '+sub.fileName+'</span>':'')+'<br><button class="btn-sm-edu btn-sm-view mt-1" onclick="viewDoc('+idx+')" aria-label="View details for '+task+'"><i class="fa-solid fa-folder-open"></i> View Details</button></td><td><span style="font-size:.92rem;font-weight:700;color:'+barCol+';">'+sc+'%</span><div class="score-bar-wrap"><div class="score-bar-track"><div class="score-bar-fill" style="width:'+sc+'%;background:'+barCol+';"></div></div><div class="score-meta">Pass mark: '+pm+'% &nbsp;&nbsp;<span class="score-delta '+(passed?'pass':'fail')+'">'+(passed?'+':'')+delta+'% '+(passed?'above':'below')+' pass</span></div></div></td><td><span class="status-badge '+(passed?'pass':'fail')+'"><i class="fa-solid '+(passed?'fa-circle-check':'fa-triangle-exclamation')+'"></i>'+(passed?'Passed':'At Risk')+'</span></td><td><button class="accordion-toggle" onclick="toggleFb(this)" aria-expanded="false"><i class="fa-solid fa-chevron-down"></i>Read Tutor Feedback</button><div class="accordion-body" role="region"><i class="fa-solid fa-chalkboard fa-sm me-1" style="color:#6090c8;"></i>'+fb+'</div></td></tr>';
  }
  function renderEnhancedFeedback(){
    const histEl=document.getElementById('history');if(!histEl)return;
    const studyId=getStudyId();
    const mine=getSubs().filter(s=>s.studyId===studyId);
    document.getElementById('statCount').textContent=mine.length;
    if(mine.length>0){const scores=mine.map(s=>scoreFor(s));const avg=Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);const passedN=mine.filter(s=>scoreFor(s)>=passFor(s)).length;document.getElementById('statAvg').textContent=avg+'%';document.getElementById('statPassed').textContent=passedN+' / '+mine.length;}
    if(mine.length===0){histEl.innerHTML='<div class="empty-state"><i class="fa-regular fa-folder-open"></i><h3>No submissions yet</h3><p>You haven\'t submitted any assignments in this session.<br><a href="./submit.html" style="color:#2558a8;font-weight:600;">Go to Submit</a> to complete your task.</p></div>';return;}
    const rows=mine.map((s,i)=>buildRow(s,i)).join('');
    histEl.innerHTML='<div class="table-wrap"><table class="fb-table" aria-label="Submission records"><thead><tr><th><i class="fa-solid fa-file-lines me-1"></i>Assignment</th><th><i class="fa-solid fa-star-half-stroke me-1"></i>Score vs Pass Mark</th><th><i class="fa-solid fa-circle-half-stroke me-1"></i>Status</th><th><i class="fa-solid fa-chalkboard me-1"></i>Tutor Feedback</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
  }
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>requestAnimationFrame(renderEnhancedFeedback));}else{requestAnimationFrame(renderEnhancedFeedback);}
  </script>
</body>
</html>
