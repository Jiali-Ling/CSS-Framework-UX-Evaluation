<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mark submissions</title>
  <link rel="icon" href="data:,">
  <link href="../shared/css/tokens.css" rel="stylesheet">
  <link href="../shared/css/bridge-bootstrap.css" rel="stylesheet">
  <link href="../shared/css/app.css" rel="stylesheet">
  <style>
    body { padding: 1.5rem 1rem; max-width: 800px; margin: 0 auto; }
    h1 { font-size: 1.4rem; font-weight: 700; margin-bottom: .25rem; }
    .form-section { margin-bottom: 1.5rem; }
    label { display: block; font-weight: 600; margin-bottom: .3rem; font-size: .9rem; }
    select, textarea, input[type="number"] { width: 100%; padding: .45rem .6rem; border: 1px solid var(--color-border, #e2e8f0); border-radius: 6px; font-size: .95rem; background: var(--color-surface, #fff); color: var(--color-text, #0f172a); }
    select { height: 2.4rem; }
    textarea { resize: vertical; }
    .help-text { font-size: .8rem; color: var(--color-muted, #64748b); margin-top: .25rem; }
    .btn { padding: .45rem 1rem; border-radius: 6px; border: none; cursor: pointer; font-size: .9rem; font-weight: 500; }
    .btn-primary { background: var(--color-primary, #2a6df4); color: #fff; }
    .btn-secondary { background: var(--color-surface-2, #f1f5f9); color: var(--color-text, #0f172a); border: 1px solid var(--color-border, #e2e8f0); }
    .btn-danger-sm { padding: .2rem .55rem; background: transparent; border: 1px solid var(--color-danger, #dc2626); color: var(--color-danger, #dc2626); border-radius: 4px; cursor: pointer; font-size: .78rem; }
    .status-msg { font-weight: 600; margin-top: .6rem; min-height: 1.25rem; }
    .marks-table { width: 100%; border-collapse: collapse; font-size: .85rem; }
    .marks-table th, .marks-table td { padding: 6px 10px; border-bottom: 1px solid var(--color-border, #e2e8f0); text-align: left; }
    .marks-table th { font-weight: 600; color: var(--color-muted, #475569); }
    .nav-row { margin-bottom: 1.25rem; }
    .nav-row a { color: var(--color-primary, #2a6df4); font-size: .875rem; text-decoration: none; }
    .nav-row a:hover { text-decoration: underline; }
    .card { background: var(--color-surface, #fff); border: 1px solid var(--color-border, #e2e8f0); border-radius: 10px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.07); }
    #submissionMeta { font-size: .82rem; color: var(--color-muted, #475569); margin-top: .4rem; padding: .4rem .6rem; background: var(--color-surface-2, #f8fafc); border-radius: 5px; display: none; }
    #submissionMeta:not(:empty) { display: block; }
  </style>
</head>
<body>

<div class="nav-row">
  <a href="./log.html">‚Üê Background log</a>
</div>

<h1>Marker admin ‚Äî Enter feedback</h1>
<p class="help-text" style="margin-bottom:1.25rem;">Select a submission, enter a score and notes, then click Save. Students will see these on their Feedback page via <em>View feedback ‚ñº</em>.</p>

<div class="card form-section">
  <div style="margin-bottom:.9rem;">
    <label for="submissionSelect">Submission</label>
    <select id="submissionSelect">
      <option value="">‚Äî Select a submission ‚Äî</option>
    </select>
    <div id="submissionMeta"></div>
  </div>

  <div style="margin-bottom:.9rem;">
    <label for="scoreInput">Score (0‚Äì100)</label>
    <input type="number" id="scoreInput" min="0" max="100" placeholder="e.g. 68" style="width:120px;">
  </div>

  <div style="margin-bottom:.9rem;">
    <label for="markerNotesInput">Marker notes</label>
    <textarea id="markerNotesInput" rows="5" placeholder="Enter detailed feedback here‚Ä¶"></textarea>
  </div>

  <div style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;">
    <button id="saveBtn" class="btn btn-primary">Save feedback</button>
    <button id="clearBtn" class="btn btn-secondary">Clear form</button>
    <span id="saveStatus" class="status-msg" aria-live="polite"></span>
  </div>
</div>

<h2 style="font-size:1rem;font-weight:600;margin-bottom:.6rem;">Existing marks</h2>
<div class="card" style="overflow-x:auto;padding:.75rem;">
  <table class="marks-table" id="marksTable">
    <thead>
      <tr>
        <th>Study ID</th>
        <th>Assignment</th>
        <th>Score</th>
        <th>Notes (preview)</th>
        <th>Graded at</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="marksTbody"></tbody>
  </table>
</div>

<script>
  const SUBMISSIONS_KEY = 'study_submissions_v1';
  const FEEDBACK_KEY = 'marker_feedback_v1';

  function loadSubmissions() {
    try { const a = JSON.parse(localStorage.getItem(SUBMISSIONS_KEY) || '[]'); return Array.isArray(a) ? a : []; }
    catch { return []; }
  }

  function loadFeedback() {
    try { const a = JSON.parse(localStorage.getItem(FEEDBACK_KEY) || '[]'); return Array.isArray(a) ? a : []; }
    catch { return []; }
  }

  function saveFeedback(arr) {
    localStorage.setItem(FEEDBACK_KEY, JSON.stringify(arr));
  }

  function getFeedbackFor(sub) {
    return loadFeedback().find(f =>
      (sub.id && f.submissionId === sub.id) ||
      (f.studyId === sub.studyId && f.createdAtISO === sub.createdAtISO)
    ) || null;
  }

  function fmt(iso) {
    try { return new Date(iso).toLocaleString(); } catch { return iso || ''; }
  }

  let submissions = [];

  function populateSelect() {
    const sel = document.getElementById('submissionSelect');
    submissions = loadSubmissions().sort((a, b) =>
      (b.createdAtISO || '').localeCompare(a.createdAtISO || '')
    );
    sel.innerHTML = '<option value="">‚Äî Select a submission ‚Äî</option>';
    submissions.forEach((sub, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      const hasFile = sub.fileDataUrl ? ' üìÑ' : '';
      const marked = getFeedbackFor(sub) ? ' ‚úÖ' : '';
      opt.textContent = `${sub.studyId} | ${sub.task} | ${fmt(sub.createdAtISO)}${hasFile}${marked}`;
      sel.appendChild(opt);
    });
  }

  function renderMarksTable() {
    const tbody = document.getElementById('marksTbody');
    const all = loadFeedback().slice().reverse();
    if (all.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="opacity:.55;padding:.6rem;">No feedback saved yet.</td></tr>';
      return;
    }
    tbody.innerHTML = '';
    all.forEach((mf, i) => {
      const sub = submissions.find(s =>
        (s.id && mf.submissionId === s.id) ||
        (s.studyId === mf.studyId && s.createdAtISO === mf.createdAtISO)
      );
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${mf.studyId || '‚Äî'}</td>
        <td>${sub ? sub.task : (mf.submissionId || '‚Äî')}</td>
        <td>${mf.score ?? '‚Äî'}</td>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${(mf.markerNotes || '').slice(0, 60)}</td>
        <td style="white-space:nowrap;">${fmt(mf.gradedAt)}</td>
        <td><button class="btn-danger-sm del-btn" data-rev="${i}">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.del-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const revIdx = parseInt(btn.dataset.rev);
        const all = loadFeedback();
        const realIdx = all.length - 1 - revIdx;
        if (!confirm('Delete this feedback entry?')) return;
        all.splice(realIdx, 1);
        saveFeedback(all);
        populateSelect();
        renderMarksTable();
      });
    });
  }

  function init() {
    populateSelect();
    renderMarksTable();

    const sel = document.getElementById('submissionSelect');
    const metaDiv = document.getElementById('submissionMeta');

    sel.addEventListener('change', () => {
      const idx = sel.value;
      if (idx === '') {
        metaDiv.textContent = '';
        document.getElementById('scoreInput').value = '';
        document.getElementById('markerNotesInput').value = '';
        document.getElementById('saveStatus').textContent = '';
        return;
      }
      const sub = submissions[Number(idx)];
      const mf = getFeedbackFor(sub);
      metaDiv.innerHTML =
        `<strong>${sub.studyId}</strong> ¬∑ ${sub.task} ¬∑ ${fmt(sub.createdAtISO)}` +
        (sub.fileName ? ` ¬∑ File: <em>${sub.fileName}</em>${sub.fileDataUrl ? '' : ' (content not stored)'}` : '') +
        (sub.comments ? `<br>Student comment: ${sub.comments}` : '');
      if (mf) {
        document.getElementById('scoreInput').value = mf.score ?? '';
        document.getElementById('markerNotesInput').value = mf.markerNotes || '';
        document.getElementById('saveStatus').textContent = 'Existing feedback loaded for editing.';
      } else {
        document.getElementById('scoreInput').value = '';
        document.getElementById('markerNotesInput').value = '';
        document.getElementById('saveStatus').textContent = '';
      }
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      const idx = sel.value;
      if (idx === '') { alert('Please select a submission first.'); return; }
      const sub = submissions[Number(idx)];
      const scoreVal = document.getElementById('scoreInput').value.trim();
      const notes = document.getElementById('markerNotesInput').value.trim();
      if (!notes) { alert('Please enter marker notes.'); return; }

      const all = loadFeedback();
      const existingIdx = all.findIndex(f =>
        (sub.id && f.submissionId === sub.id) ||
        (f.studyId === sub.studyId && f.createdAtISO === sub.createdAtISO)
      );
      const entry = {
        submissionId: sub.id || `${sub.studyId}_${sub.createdAtISO}`,
        studyId: sub.studyId,
        createdAtISO: sub.createdAtISO,
        score: scoreVal !== '' ? Number(scoreVal) : null,
        markerNotes: notes,
        gradedAt: new Date().toISOString(),
      };
      if (existingIdx >= 0) {
        all[existingIdx] = entry;
      } else {
        all.push(entry);
      }
      saveFeedback(all);

      const statusEl = document.getElementById('saveStatus');
      statusEl.textContent = '‚úÖ Feedback saved!';
      statusEl.style.color = 'var(--color-success, #16a34a)';
      setTimeout(() => { statusEl.textContent = ''; }, 3000);

      populateSelect();
      renderMarksTable();
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      sel.value = '';
      metaDiv.textContent = '';
      document.getElementById('scoreInput').value = '';
      document.getElementById('markerNotesInput').value = '';
      document.getElementById('saveStatus').textContent = '';
    });
  }

  init();
</script>
</body>
</html>
